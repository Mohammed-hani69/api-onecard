# نظام OneCard API - متجر إلكتروني متكامل

هذا النظام يوفر منصة متكاملة للتواصل مع API Bitaqaty Business لبيع المنتجات والقيام بمعاملات التسوق.

## المميزات الرئيسية

✅ **احضار المنتجات من API** - تحديث قائمة المنتجات من الخادم الخارجي
✅ **إدارة السلة** - إضافة وحذف المنتجات من السلة
✅ **نظام الدفع** - معالجة عمليات الشراء والتحويل إلى API
✅ **تتبع المعاملات** - حفظ وعرض سجل جميع العمليات
✅ **فحص الرصيد** - عرض الرصيد الحالي وتحديثه
✅ **واجهة عربية** - دعم كامل للغة العربية من اليمين إلى اليسار
✅ **تصميم استجابي** - يعمل على جميع أحجام الشاشات

## البنية الأساسية للمشروع

```
api-onecard/
├── app.py                   # الملف الرئيسي للتطبيق (الروتات والمعالجات)
├── config.py               # إعدادات التطبيق والثوابت
├── models.py               # نماذج قاعدة البيانات
├── api_service.py          # خدمة التواصل مع API الخارجي
├── requirements.txt        # المكتبات المطلوبة
├── docs.md                # دوكيومنتيشن API الأصلي
├── templates/              # ملفات HTML
│   ├── index.html         # الصفحة الرئيسية
│   ├── products.html      # صفحة المنتجات
│   ├── cart.html          # صفحة السلة
│   ├── checkout.html      # صفحة الدفع
│   └── transactions.html  # صفحة المعاملات
└── static/
    ├── css/
    │   └── style.css      # أنماط CSS
    └── js/
        └── main.js        # سكريبت JavaScript
```

## متطلبات التشغيل

- Python 3.7 أو أعلى
- pip (مدير حزم Python)
- متصفح ويب حديث

## التثبيت والتشغيل

### 1. تثبيت المتطلبات

```bash
pip install -r requirements.txt
```

### 2. تشغيل التطبيق

```bash
python app.py
```

### 3. الوصول إلى التطبيق

افتح متصفحك وانتقل إلى:
```
http://localhost:5000
```

## دليل الاستخدام

### 1. الصفحة الرئيسية
- عرض إحصائيات الرصيد والمنتجات والمعاملات
- زر لتحديث قائمة المنتجات من API

### 2. صفحة المنتجات
- البحث عن المنتجات بالاسم أو الكود
- التصفية حسب الفئة
- عرض تفاصيل كاملة لكل منتج
- إضافة المنتجات إلى السلة

### 3. سلة التسوق
- عرض جميع العناصر المضافة
- حذف العناصر غير المرغوبة
- عرض المجموع النهائي
- الانتقال إلى صفحة الدفع

### 4. صفحة الدفع
- مراجعة تفاصيل الطلب
- عرض الرصيد الحالي
- تأكيد العملية والدفع

### 5. سجل المعاملات
- عرض جميع المعاملات السابقة
- التصفية حسب حالة المعاملة
- عرض تفاصيل كاملة لكل عملية

## شرح الملفات الرئيسية

### app.py
يحتوي على جميع الروتات (Routes) والمعالجات الخاصة بالتطبيق:

**الروتات الأساسية:**
- `/` - الصفحة الرئيسية
- `/products` - صفحة المنتجات
- `/cart` - سلة التسوق
- `/checkout` - صفحة الدفع
- `/transactions` - سجل المعاملات

**روتات API:**
- `POST /api/products/fetch` - احضار المنتجات من API
- `GET /api/balance/check` - فحص الرصيد
- `POST /api/cart/add` - إضافة منتج للسلة
- `DELETE /api/cart/remove/<id>` - حذف منتج من السلة
- `POST /api/purchase` - إجراء عملية شراء
- `GET /api/product/<id>` - احضار معلومات منتج محدد

### config.py
يحتوي على:
- بيانات الاتصال بـ API (RESELLER_USERNAME, SECRET_KEY, MERCHANT_ID)
- معاملات المنتجات المراد احضارها
- دوال توليد كلمات المرور MD5

### models.py
يحتوي على نماذج قاعدة البيانات:
- `Product` - معلومات المنتجات
- `CartItem` - عناصر السلة
- `Transaction` - سجل المعاملات
- `Balance` - معلومات الرصيد

### api_service.py
فئة `APIService` تحتوي على جميع الدوال للتواصل مع API:
- `check_balance()` - فحص الرصيد
- `get_detailed_products_list()` - احضار المنتجات
- `get_product_details()` - معلومات منتج محدد
- `bill_inquire()` - استعلام الفاتورة
- `calculate_topup_amount()` - حساب السعر النهائي
- `make_purchase()` - عملية الشراء

## شرح آلية التواصل مع API

### 1. توليد كلمة المرور
جميع الطلبات تتطلب كلمة مرور MD5 مشفرة:
```python
password = MD5(resellerUsername + [optional: productId/resellerRefNumber] + secretKey)
```

### 2. طلب احضار المنتجات
```python
POST https://bbapi.ocstaging.net/integration/detailed-products-list
{
    "resellerUsername": "business@es-gift.com",
    "password": "MD5_HASH",
    "merchantId": "315325"
}
```

### 3. عملية الشراء
```python
POST https://bbapi.ocstaging.net/integration/service-bill-pay
{
    "resellerUsername": "business@es-gift.com",
    "password": "MD5_HASH",
    "resellerRefNumber": "UNIQUE_ID",
    "productId": "PRODUCT_CODE",
    "inputParameters": {}
}
```

## معالجة الأخطاء

التطبيق يعالج جميع الأخطاء المحتملة:
- ❌ أخطاء الاتصال بـ API
- ❌ رصيد غير كافي
- ❌ منتج غير متاح
- ❌ أخطاء قاعدة البيانات

## أمان التطبيق

⚠️ **نصائح أمنية مهمة:**
1. غير `SECRET_KEY` في الملف `config.py` إلى قيمة قوية
2. لا تكشف معلومات الاتصال بـ API
3. استخدم HTTPS في الإنتاج
4. تحقق من صحة جميع المدخلات
5. قم بحماية قاعدة البيانات

## المتغيرات البيئية (اختياري)

يمكن استخدام متغيرات البيئة للتكوين الآمن:
```bash
set FLASK_ENV=production
set SECRET_KEY=your-secret-key
```

## حل المشاكل الشائعة

### المشكلة: خطأ "Address already in use"
**الحل:** غير رقم المنفذ في `app.py`:
```python
app.run(port=5001)  # بدلاً من 5000
```

### المشكلة: قاعدة البيانات لا تحفظ البيانات
**الحل:** تأكد من وجود ملف `app.db` والصلاحيات المناسبة

### المشكلة: API لا يستجيب
**الحل:** 
1. تحقق من الاتصال بالإنترنت
2. تحقق من بيانات الاعتماد
3. جرب الـ API مباشرة باستخدام Postman

## معلومات إضافية

### البيانات المستخدمة
- **اسم المستخدم:** business@es-gift.com
- **معرف التاجر:** 315325
- **المفتاح السري:** vKLvDUP50tyLqA1e

### الرموز المتاحة
تم تحميل أكثر من 600 رمز منتج من قائمتك

### العملة
السعة الافتراضية هي SAR (الريال السعودي)

## التطوير المستقبلي

- [ ] إضافة نظام المستخدمين والحسابات
- [ ] نظام الفواتير والإيصالات
- [ ] تقارير مفصلة عن المبيعات
- [ ] نظام الخصومات والعروضات
- [ ] دعم طرق دفع متعددة
- [ ] تطبيق موبايل

## الدعم والمساعدة

في حالة وجود أي مشاكل أو استفسارات:
1. تحقق من رسائل الأخطاء في كونسول المتصفح (F12)
2. تحقق من سجلات الخادم
3. راجع الدوكيومنتيشن الأصلي في `docs.md`

## الترخيص

هذا المشروع مفتوح المصدر ومتاح للاستخدام الحر.

---

**تم الإنشاء:** 2024
**آخر تحديث:** 2024
**الإصدار:** 1.0
