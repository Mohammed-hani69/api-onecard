<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุฏูุน - OneCard API</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- ุดุฑูุท ุงูุชููู -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <h1>๐ ูุชุฌุฑ OneCard</h1>
            </div>
            <ul class="navbar-menu">
                <li><a href="/" class="nav-link">ุงูุฑุฆูุณูุฉ</a></li>
                <li><a href="/products" class="nav-link">ุงูููุชุฌุงุช</a></li>
                <li><a href="/cart" class="nav-link">ุงูุณูุฉ <span class="cart-count" id="cartCount">0</span></a></li>
                <li><a href="/transactions" class="nav-link">ุงููุนุงููุงุช</a></li>
            </ul>
        </div>
    </nav>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <main class="container">
        <h2>๐ณ ุตูุญุฉ ุงูุฏูุน ูุงูุชุฃููุฏ</h2>
        
        <div class="checkout-container">
            <!-- ูุนูููุงุช ุงูุทูุจ -->
            <section class="order-summary">
                <h3>ููุฎุต ุงูุทูุจ</h3>
                
                {% if cart_items %}
                    <table class="order-table">
                        <thead>
                            <tr>
                                <th>ุงูููุชุฌ</th>
                                <th>ุงูููุฏ</th>
                                <th>ุงูุณุนุฑ</th>
                                <th>ุงููููุฉ</th>
                                <th>ุงููุฌููุน</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in cart_items %}
                                <tr>
                                    <td>{{ item.product.name_ar or item.product.name_en }}</td>
                                    <td>{{ item.product.product_id }}</td>
                                    <td>{{ "%.2f"|format(item.price) }} ุฑ.ุณ</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ "%.2f"|format(item.price * item.quantity) }} ุฑ.ุณ</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- ุงููุฌููุน -->
                    <div class="order-totals">
                        <div class="total-row">
                            <span>ุฅุฌูุงูู ุงูููุชุฌุงุช:</span>
                            <strong>{{ "%.2f"|format(total) }} ุฑ.ุณ</strong>
                        </div>
                        <div class="total-row highlight">
                            <span>ุงูุฅุฌูุงูู ุงูููุงุฆู:</span>
                            <strong>{{ "%.2f"|format(total) }} ุฑ.ุณ</strong>
                        </div>
                    </div>
                {% endif %}
            </section>

            <!-- ูุนูููุงุช ุงูุฑุตูุฏ -->
            <section class="balance-section">
                <h3>ูุนูููุงุช ุงูุฑุตูุฏ</h3>
                <div class="balance-info">
                    <p>ุงูุฑุตูุฏ ุงูุญุงูู:</p>
                    <h2 class="balance-value" id="currentBalance">{{ "%.2f"|format(balance) }} ุฑ.ุณ</h2>
                    <button class="btn btn-sm btn-primary" onclick="updateBalance()">ุชุญุฏูุซ ุงูุฑุตูุฏ</button>
                </div>

                {% if balance >= total %}
                    <div class="balance-success">
                        โ ุงูุฑุตูุฏ ูุงูู ูุฅุฌุฑุงุก ุงูุนูููุฉ
                    </div>
                {% else %}
                    <div class="balance-warning">
                        โ ุงูุฑุตูุฏ ุบูุฑ ูุงูู! 
                        <br>
                        ุงููุงูุต: {{ "%.2f"|format(total - balance) }} ุฑ.ุณ
                    </div>
                {% endif %}
            </section>

            <!-- ูููุฐุฌ ุงูุฏูุน -->
            <section class="payment-form">
                <h3>ุชุฃููุฏ ุงูุฏูุน</h3>
                <form id="paymentForm" onsubmit="submitPayment(event)">
                    <div class="form-group">
                        <label for="paymentMethod">ุทุฑููุฉ ุงูุฏูุน:</label>
                        <select id="paymentMethod" class="form-control" required>
                            <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน</option>
                            <option value="balance">ูู ุงูุฑุตูุฏ ุงูุญุงูู</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="notes">ููุงุญุธุงุช (ุงุฎุชูุงุฑู):</label>
                        <textarea id="notes" class="form-control" rows="3" placeholder="ุฃู ููุงุญุธุงุช ุนูู ุงูุทูุจ..."></textarea>
                    </div>

                    {% if balance >= total %}
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            โ ุชุฃููุฏ ุงูุทูุจ ูุงูุฏูุน
                        </button>
                    {% else %}
                        <button type="submit" class="btn btn-disabled btn-lg" disabled>
                            ุงูุฑุตูุฏ ุบูุฑ ูุงูู
                        </button>
                    {% endif %}
                </form>
            </section>
        </div>

        <!-- ูุชูุฌุฉ ุงูุฏูุน -->
        <div id="paymentResult" class="payment-result" style="display: none;">
            <h3 id="resultTitle">ุฌุงุฑู ูุนุงูุฌุฉ ุงูุฏูุน...</h3>
            <div id="resultContent"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2024 ูุธุงู OneCard API. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
    </footer>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // ุชุญุฏูุซ ุนุฏุฏ ุงูุณูุฉ
        updateCartCount();

        // ุฏุงูุฉ ุชุญุฏูุซ ุงูุฑุตูุฏ
        function updateBalance() {
            fetch('/api/balance/check')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('currentBalance').textContent = 
                            parseFloat(data.balance).toFixed(2) + ' ุฑ.ุณ';
                        showNotification('ุชู ุชุญุฏูุซ ุงูุฑุตูุฏ ุจูุฌุงุญ', 'success');
                    } else {
                        showNotification('ุฎุทุฃ: ' + data.message, 'error');
                    }
                });
        }

        // ุฏุงูุฉ ุฅุฑุณุงู ุงูุฏูุน
        function submitPayment(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ุฌุงุฑู ูุนุงูุฌุฉ...';

            // ุฅุฎูุงุก ุงููููุฐุฌ ูุนุฑุถ ุงููุชูุฌุฉ
            document.querySelector('.payment-form').style.display = 'none';
            document.getElementById('paymentResult').style.display = 'block';

            // ุฅุฑุณุงู ุทูุจ ุงูุฏูุน
            fetch('/api/purchase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                const resultTitle = document.getElementById('resultTitle');
                const resultContent = document.getElementById('resultContent');

                if (data.success) {
                    resultTitle.textContent = 'โ ุชู ุงูุฏูุน ุจูุฌุงุญ';
                    resultTitle.className = 'success';
                    
                    let html = '<div class="success-message">';
                    html += '<p>ุชูุช ูุนุงูุฌุฉ ุงูุทูุจ ุจูุฌุงุญ</p>';
                    
                    if (data.transactions && data.transactions.length > 0) {
                        html += '<h4>ุชูุงุตูู ุงููุนุงููุงุช:</h4>';
                        html += '<ul>';
                        data.transactions.forEach(transaction => {
                            html += '<li>';
                            html += 'ุงูููุชุฌ: ' + transaction.product_name + '<br>';
                            html += 'ุงูุญุงูุฉ: ' + (transaction.status === 'success' ? 'โ ูุงุฌุญ' : 'โ ูุดู') + '<br>';
                            html += 'ุงููุจูุบ: ' + transaction.total_price.toFixed(2) + ' ุฑ.ุณ';
                            html += '</li>';
                        });
                        html += '</ul>';
                    }
                    
                    html += '</div>';
                    resultContent.innerHTML = html;

                    // ุฅุนุงุฏุฉ ุงูุชูุฌูู ุจุนุฏ 3 ุซูุงู
                    setTimeout(() => {
                        window.location.href = '/transactions';
                    }, 3000);
                } else {
                    resultTitle.textContent = 'โ ูุดู ุงูุฏูุน';
                    resultTitle.className = 'error';
                    resultContent.innerHTML = '<div class="error-message"><p>' + data.message + '</p></div>';
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'โ ุชุฃููุฏ ุงูุทูุจ ูุงูุฏูุน';
                    document.querySelector('.payment-form').style.display = 'block';
                    document.getElementById('paymentResult').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('resultTitle').textContent = 'โ ุฎุทุฃ ูู ุงูุงุชุตุงู';
                document.getElementById('resultContent').innerHTML = 
                    '<div class="error-message"><p>ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุทูุจ</p></div>';
            });
        }
    </script>
</body>
</html>
